#!/usr/bin/env bash
# tools/self-improvement — thin wrapper bridging SKILL.md commands to `blacksmith improve`
#
# Improvement subcommands delegate to `blacksmith improve`.
# Session subcommands (status, analyze, targets, log, backfill, seed) are
# placeholders until the Rust binary lands.
set -euo pipefail

# Resolve the blacksmith binary.  Prefer $BLACKSMITH_BIN, then cargo target, then PATH.
resolve_blacksmith() {
    if [[ -n "${BLACKSMITH_BIN:-}" ]] && [[ -x "$BLACKSMITH_BIN" ]]; then
        echo "$BLACKSMITH_BIN"
        return
    fi

    # Walk up from this script to find the project root (contains Cargo.toml)
    local dir
    dir="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
    while [[ "$dir" != "/" ]]; do
        if [[ -f "$dir/Cargo.toml" ]]; then
            for candidate in "$dir/target/debug/blacksmith" "$dir/target/release/blacksmith"; do
                if [[ -x "$candidate" ]]; then
                    echo "$candidate"
                    return
                fi
            done
        fi
        dir="$(dirname "$dir")"
    done

    # Fall back to PATH
    if command -v blacksmith &>/dev/null; then
        echo "blacksmith"
        return
    fi

    echo >&2 "Error: cannot find blacksmith binary. Set BLACKSMITH_BIN or build with cargo build."
    exit 1
}

BLACKSMITH="$(resolve_blacksmith)"

# ── severity → category mapping ──────────────────────────────────────────────
# SKILL.md exposes --severity (high|medium|low) for agent ergonomics.
# blacksmith improve uses --category (workflow|cost|reliability|performance|code-quality).
# Default category when only severity is given:
severity_to_category() {
    case "${1:-}" in
        high)   echo "reliability" ;;
        medium) echo "workflow" ;;
        low)    echo "code-quality" ;;
        *)      echo "workflow" ;;
    esac
}

usage() {
    cat <<'EOF'
Usage: tools/self-improvement <command> [args]

Improvement commands (bridged to blacksmith improve):
  improvement list [--status STATUS]                    List improvements
  improvement search <query>                            Search improvements
  improvement add --title "..." [--severity high|medium|low]
                   [--category CAT] [--desc "..."] [--rec "..."] [--tags "..."]
                                                        Add new improvement
  improvement fix <ref_id> [--impact "..."]             Mark fixed (promoted)

Session commands (requires Rust binary — not yet available):
  status [--last N]          Dashboard with recent sessions
  analyze [--last N]         Deep analysis
  targets                    Show efficiency targets
  log <jsonl-file>           Parse one session file
  backfill [--from N] [--to N]  Bulk-parse session files
  seed                       Populate improvements from history
EOF
}

# ── improvement subcommand router ────────────────────────────────────────────

cmd_improvement() {
    local subcmd="${1:-}"
    shift || true

    case "$subcmd" in
        list)    cmd_improvement_list "$@" ;;
        search)  cmd_improvement_search "$@" ;;
        add)     cmd_improvement_add "$@" ;;
        fix)     cmd_improvement_fix "$@" ;;
        *)
            echo >&2 "Unknown improvement subcommand: $subcmd"
            echo >&2 "Available: list, search, add, fix"
            exit 1
            ;;
    esac
}

cmd_improvement_list() {
    # Pass --status through directly
    "$BLACKSMITH" improve list "$@"
}

cmd_improvement_search() {
    if [[ $# -lt 1 ]]; then
        echo >&2 "Usage: tools/self-improvement improvement search <query>"
        exit 1
    fi
    "$BLACKSMITH" improve search "$@"
}

cmd_improvement_add() {
    local title="" severity="" category="" desc="" rec="" tags=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --title)    title="$2"; shift 2 ;;
            --severity) severity="$2"; shift 2 ;;
            --category) category="$2"; shift 2 ;;
            --desc)     desc="$2"; shift 2 ;;
            --rec)      rec="$2"; shift 2 ;;
            --tags)     tags="$2"; shift 2 ;;
            *)
                echo >&2 "Unknown flag: $1"
                exit 1
                ;;
        esac
    done

    if [[ -z "$title" ]]; then
        echo >&2 "Error: --title is required"
        exit 1
    fi

    # Resolve category: explicit --category wins, else map from severity
    if [[ -z "$category" ]]; then
        category="$(severity_to_category "$severity")"
    fi

    # Build body from --desc and --rec
    local body=""
    if [[ -n "$desc" ]] && [[ -n "$rec" ]]; then
        body="${desc}

**Recommendation:** ${rec}"
    elif [[ -n "$desc" ]]; then
        body="$desc"
    elif [[ -n "$rec" ]]; then
        body="**Recommendation:** ${rec}"
    fi

    # Assemble blacksmith improve add args
    local args=("$title" --category "$category")
    if [[ -n "$body" ]]; then
        args+=(--body "$body")
    fi
    if [[ -n "$tags" ]]; then
        args+=(--tags "$tags")
    fi

    "$BLACKSMITH" improve add "${args[@]}"
}

cmd_improvement_fix() {
    local ref_id="${1:-}"
    shift || true

    if [[ -z "$ref_id" ]]; then
        echo >&2 "Usage: tools/self-improvement improvement fix <ref_id> [--impact \"...\"]"
        exit 1
    fi

    local impact=""
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --impact) impact="$2"; shift 2 ;;
            *)
                echo >&2 "Unknown flag: $1"
                exit 1
                ;;
        esac
    done

    # If impact provided, store it as context before promoting
    if [[ -n "$impact" ]]; then
        "$BLACKSMITH" improve update "$ref_id" --context "Impact: $impact"
    fi

    "$BLACKSMITH" improve promote "$ref_id"
}

# ── top-level router ─────────────────────────────────────────────────────────

cmd="${1:-}"
shift || true

case "$cmd" in
    improvement)
        cmd_improvement "$@"
        ;;
    status|analyze|targets|log|backfill|seed)
        echo >&2 "Error: '$cmd' requires the Rust self-improvement binary (not yet built)."
        echo >&2 "These session commands will be available after simple-agent-harness-maxs lands."
        exit 1
        ;;
    -h|--help|help|"")
        usage
        ;;
    *)
        echo >&2 "Unknown command: $cmd"
        usage
        exit 1
        ;;
esac
